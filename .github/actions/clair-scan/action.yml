name: 'Clair Scan'
description: 'Perform a vulnerability scan on an image'
inputs:
  image_path:
    description: 'where to find the image tar'
    default: '/tmp/${{ github.sha }}'
  fail:
    description: 'whether to fail if vulnerabilities are found'
    default: 'true'
runs:
  using: 'docker'
  image: quay.io/crozzy/local-clair:latest
  steps:
    - name: Download artifact
      uses: actions/download-artifact@master
      with:
        name: built-image
        path: /tmp
    - name: Scan Image
      run: |
        DB_PATH=/matcher IMAGE_PATH=${{ inputs.image_path }} /bin/local-clair report > ${{ inputs.image_path }}_vulnerability_report.sarif

    - name: Upload sarif 
      uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: ${{ inputs.image_path }}_vulnerability_report.sarif
    - name: Upload vulnerability report
      uses: actions/upload-artifact@master
      with:
        name: vulnerability-report
        path: ${{ inputs.image_path }}_vulnerability_report.sarif
